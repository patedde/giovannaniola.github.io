---
const { 
  lang = 'it', 
  url = 'https://calendly.com/YOUR_USERNAME/50min' 
} = Astro.props;

// Validation: warn if URL not updated
if (url.includes('YOUR_USERNAME')) {
  console.warn('⚠️  CalendlyEmbed: Update url prop with your actual Calendly link');
}
---

<div data-requires-calendly-consent class="max-w-3xl mx-auto px-4">
  <div id="calendly-container" class="min-h-[700px] border rounded bg-slate-50 flex items-center justify-center">
    <p class="text-slate-600 text-center px-4">
      {lang === 'it' 
        ? 'Accetta i cookie per caricare il calendario di prenotazione.' 
        : 'Accept cookies to load the booking calendar.'}
    </p>
  </div>
  <noscript>
    {lang === 'it'
      ? <p class="mt-4 text-center">Per prenotare senza JavaScript, apri <a class="underline text-emerald-600" href={url} target="_blank" rel="noopener noreferrer">Calendly</a>.</p>
      : <p class="mt-4 text-center">To book without JavaScript, open <a class="underline text-emerald-600" href={url} target="_blank" rel="noopener noreferrer">Calendly</a>.</p>}
  </noscript>
</div>

<script is:inline define:vars={{ url }}>
  function loadCalendly() {
    if (document.getElementById('calendly-script')) return;
    
    const container = document.getElementById('calendly-container');
    if (container) {
      container.innerHTML = ''; // Clear placeholder message
    }
    
    const s = document.createElement('script');
    s.id = 'calendly-script';
    s.src = 'https://assets.calendly.com/assets/external/widget.js';
    s.onload = () => {
      if (window.Calendly && container) {
        window.Calendly.initInlineWidget({
          url: url,
          parentElement: container,
          prefill: {},
          utm: {}
        });
      }
    };
    s.onerror = () => {
      if (container) {
        container.innerHTML = '<p class="text-red-600 text-center">Failed to load calendar. Please try again later.</p>';
      }
    };
    document.body.appendChild(s);
  }
  
  document.addEventListener('calendly-consented', loadCalendly);
  
  // Auto-load if user has already consented in a previous visit
  if (localStorage.getItem('calendly-consent') === 'granted') {
    loadCalendly();
  }
</script>

<link rel="stylesheet" href="https://assets.calendly.com/assets/external/widget.css">